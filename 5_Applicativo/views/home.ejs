<%
const currentPage = 'home';
const title = 'Chat';
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - P2P Secure Chat</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fab fa-telegram"></i>
                    <span>P2P Secure Chat</span>
                </div>
                <nav class="nav">
                    <span class="user-info">
                        <i class="fas fa-user"></i> <%= user.username %>
                        <span class="status-indicator online"></span>
                    </span>
                    <a href="/settings" class="nav-link">
                        <i class="fas fa-cog"></i> Impostazioni
                    </a>
                </nav>
            </div>
        </header>

        <main class="main-content">
            <div class="telegram-layout">
                <!-- COLONNA SINISTRA - LISTA CONTATTI -->
                <div class="contacts-sidebar">
                    <div class="sidebar-header">
                        <h3>Chat</h3>
                        <div class="header-actions">
                            <button class="btn btn-sm btn-outline" onclick="scanNetwork()" title="Scansione rete">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="showAddContact()" title="Aggiungi contatto">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="contactSearch" placeholder="Cerca contatti..." class="search-input">
                    </div>
                    
                    <div class="contacts-list" id="contactsList">
                        <!-- I contatti verranno caricati qui via JavaScript -->
                    </div>
                </div>

                <!-- COLONNA DESTRA - AREA CHAT -->
                <div class="chat-area">
                    <div class="no-chat-selected" id="noChatSelected">
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>Seleziona una chat per iniziare</h3>
                            <p>Scegli un contatto dalla lista per iniziare una conversazione</p>
                        </div>
                    </div>

                    <div class="active-chat" id="activeChat" style="display: none;">
                        <div class="chat-header-single">
                            <div class="peer-info-large">
                                <div class="peer-avatar-large">
                                    <i class="fas fa-user" id="currentPeerAvatar"></i>
                                </div>
                                <div class="peer-details-large">
                                    <h3 id="currentPeerName">Nome contatto</h3>
                                    <p class="peer-address" id="currentPeerAddress">indirizzo</p>
                                    <div class="peer-status-info">
                                        <span class="status-indicator" id="currentPeerStatus"></span>
                                        <span id="currentPeerStatusText">Stato</span>
                                        <span class="connection-status" id="currentPeerConnection"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="peer-actions-single">
                                <button class="btn btn-sm btn-outline" onclick="refreshChat()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="messages-container-single" id="messagesContainer">
                            <!-- Messaggi della chat verranno caricati qui -->
                        </div>
                        
                        <div class="message-input-container-single">
                            <form id="messageForm" class="message-form">
                                <input type="hidden" id="currentPeerId">
                                <div class="input-group">
                                    <input type="text" id="messageInput" 
                                           placeholder="Scrivi un messaggio..." 
                                           maxlength="500"
                                           required>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modale per aggiungere contatto -->
        <div id="addContactModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Aggiungi contatto</h3>
                    <button class="btn btn-sm" onclick="closeAddContact()">&times;</button>
                </div>
                <form id="addContactForm" class="modal-body">
                    <div class="form-group">
                        <label>Indirizzo IP del peer:</label>
                        <input type="text" id="newContactIp" placeholder="es. 192.168.1.100" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="closeAddContact()">Annulla</button>
                        <button type="submit" class="btn btn-primary">Aggiungi</button>
                    </div>
                </form>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <p>P2P Secure Chat - Comunicazione crittata end-to-end</p>
            </div>
        </footer>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // VARIABILI GLOBALI
        const socket = io();
        let currentPeer = null;
        let allContacts = [];

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            loadContacts();
            setupEventListeners();
            
            // Unisciti alla room globale per aggiornamenti
            socket.emit('join-home');
        });

        // CARICA LISTA CONTATTI
        async function loadContacts() {
            try {
                const response = await fetch('/api/peers');
                const data = await response.json();
                
                if (data.success) {
                    allContacts = data.peers;
                    renderContacts(allContacts);
                }
            } catch (error) {
                console.error('Errore caricamento contatti:', error);
            }
        }

        // RENDER LISTA CONTATTI
        function renderContacts(contacts) {
            const contactsList = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                contactsList.innerHTML = `
                    <div class="empty-contacts">
                        <i class="fas fa-users"></i>
                        <p>Nessun contatto trovato</p>
                        <button class="btn btn-sm btn-primary" onclick="scanNetwork()">
                            Scansione rete
                        </button>
                    </div>
                `;
                return;
            }

            contactsList.innerHTML = contacts.map(contact => {
                const lastMessage = getLastMessagePreview(contact);
                const isActive = currentPeer && currentPeer.ip === contact.ip && currentPeer.port === contact.port;
                
                return `
                <div class="contact-item ${isActive ? 'active' : ''}" 
                     onclick="selectContact('${contact.ip}', ${contact.port})">
                    <div class="contact-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="contact-info">
                        <h4>${contact.username || 'Sconosciuto'}</h4>
                        <p class="contact-last-message">${lastMessage}</p>
                    </div>
                    <div class="contact-meta">
                        <span class="contact-time">${formatLastSeen(contact.last_seen)}</span>
                        <div class="contact-status ${contact.public_key ? 'encrypted' : 'plain'}">
                            ${contact.public_key ? 'ðŸ”’' : 'ðŸ”“'}
                            ${contact.isConnected ? 'ðŸŸ¢' : 'ðŸ”´'}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // SELEZIONA UN CONTATTO
        async function selectContact(ip, port) {
            try {
                const response = await fetch(`/api/peer-info/${ip}/${port}`);
                const data = await response.json();
                
                if (data.success) {
                    currentPeer = data.peer;
                    showChatArea();
                    loadChatMessages(ip, port);
                    
                    // Aggiorna UI
                    document.getElementById('currentPeerName').textContent = currentPeer.username || 'Sconosciuto';
                    document.getElementById('currentPeerAddress').textContent = `${currentPeer.ip}:${currentPeer.port}`;
                    document.getElementById('currentPeerId').value = `${currentPeer.ip}:${currentPeer.port}`;
                    
                    const statusElement = document.getElementById('currentPeerStatus');
                    const statusText = document.getElementById('currentPeerStatusText');
                    const connectionElement = document.getElementById('currentPeerConnection');
                    
                    if (currentPeer.public_key) {
                        statusElement.className = 'status-indicator encrypted';
                        statusText.textContent = 'Comunicazione cifrata';
                    } else {
                        statusElement.className = 'status-indicator plain';
                        statusText.textContent = 'Comunicazione in chiaro';
                    }
                    
                    if (currentPeer.isConnected) {
                        connectionElement.className = 'connection-status connected';
                        connectionElement.textContent = 'ðŸŸ¢ Connesso';
                        document.getElementById('messageInput').disabled = false;
                        document.getElementById('messageInput').placeholder = 'Scrivi un messaggio...';
                    } else {
                        connectionElement.className = 'connection-status disconnected';
                        connectionElement.textContent = 'ðŸ”´ Disconnesso';
                        document.getElementById('messageInput').disabled = true;
                        document.getElementById('messageInput').placeholder = 'Connetti per inviare messaggi...';
                    }
                    
                    // Aggiorna highlight contatto
                    renderContacts(allContacts);
                }
            } catch (error) {
                console.error('Errore selezione contatto:', error);
                showToast('Errore nel caricamento del contatto', 'error');
            }
        }

        // MOSTRA/NASCONDI AREA CHAT
        function showChatArea() {
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('activeChat').style.display = 'flex';
        }

        function hideChatArea() {
            document.getElementById('noChatSelected').style.display = 'flex';
            document.getElementById('activeChat').style.display = 'none';
            currentPeer = null;
        }

        // CARICA MESSAGGI DELLA CHAT
        async function loadChatMessages(ip, port) {
            try {
                const response = await fetch(`/api/private-messages/${ip}/${port}`);
                const data = await response.json();
                
                if (data.success) {
                    renderMessages(data.messages);
                }
            } catch (error) {
                console.error('Errore caricamento messaggi:', error);
            }
        }

        // RENDER MESSAGGI
        function renderMessages(messages) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = messages.map(message => `
                <div class="message ${message.direction === 'outgoing' ? 'outgoing' : 'incoming'}">
                    <div class="message-header">
                        <span class="sender">
                            ${message.direction === 'outgoing' ? 'Tu' : (currentPeer?.username || 'Sconosciuto')}
                        </span>
                        <span class="time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">
                        ${message.message}
                    </div>
                    <div class="message-footer">
                        <span class="message-type">${message.chat_type === 'group' ? 'ðŸ“¢ Gruppo' : 'ðŸ”’ Privato'}</span>
                    </div>
                </div>
            `).join('');
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // INVIO MESSAGGIO
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPeer) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch('/api/send-private-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        peerAddress: `${currentPeer.ip}:${currentPeer.port}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageInput.value = '';
                    // Ricarica i messaggi per mostrare quello nuovo
                    loadChatMessages(currentPeer.ip, currentPeer.port);
                    // Aggiorna la lista contatti per l'anteprima
                    loadContacts();
                } else {
                    console.error('Errore invio messaggio:', data.error);
                    showToast('Errore nell\'invio del messaggio: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Errore invio messaggio:', error);
                showToast('Errore di connessione', 'error');
            }
        });

        // WEB SOCKET - MESSAGGI IN TEMPO REALE
        socket.on('new-private-message', (data) => {
            // Se abbiamo un peer selezionato e il messaggio Ã¨ per lui, aggiungilo alla chat
            if (currentPeer && data.peerAddress === `${currentPeer.ip}:${currentPeer.port}`) {
                addMessageToChat(data);
            }
            // In ogni caso, aggiorna la lista contatti per mostrare l'ultimo messaggio
            loadContacts();
        });

        socket.on('peers-updated', (data) => {
            allContacts = data.peers;
            renderContacts(allContacts);
            
            // Se il peer corrente Ã¨ cambiato stato, aggiorna l'UI
            if (currentPeer) {
                const updatedPeer = data.peers.find(p => p.ip === currentPeer.ip && p.port === currentPeer.port);
                if (updatedPeer) {
                    currentPeer = updatedPeer;
                    selectContact(currentPeer.ip, currentPeer.port);
                }
            }
        });

        function addMessageToChat(data) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${data.direction === 'outgoing' ? 'outgoing' : 'incoming'}`;
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">
                        ${data.direction === 'outgoing' ? 'Tu' : (currentPeer?.username || 'Sconosciuto')}
                    </span>
                    <span class="time">${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    ${data.message}
                </div>
                <div class="message-footer">
                    <span class="message-type">ðŸ”’ Privato</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // FUNZIONI AUSILIARIE
        function getLastMessagePreview(contact) {
            // Implementazione semplificata - nella realtÃ  dovresti recuperare l'ultimo messaggio
            if (contact.isConnected) {
                return contact.public_key ? 'Comunicazione sicura' : 'Comunicazione in chiaro';
            }
            return 'Non connesso';
        }

        function formatLastSeen(lastSeen) {
            if (!lastSeen) return 'Mai visto';
            const now = new Date();
            const lastSeenDate = new Date(lastSeen);
            const diffMs = now - lastSeenDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) return 'Ora';
            if (diffMins < 60) return `${diffMins} min fa`;
            if (diffHours < 24) return `${diffHours} ore fa`;
            return lastSeenDate.toLocaleDateString();
        }

        function setupEventListeners() {
            // Ricerca contatti
            document.getElementById('contactSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredContacts = allContacts.filter(contact => 
                    (contact.username || 'Sconosciuto').toLowerCase().includes(searchTerm) ||
                    contact.ip.includes(searchTerm)
                );
                renderContacts(filteredContacts);
            });
        }

        // FUNZIONI GLOBALI
        async function scanNetwork() {
            try {
                const response = await fetch('/api/scan-network', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Scansione rete avviata!', 'success');
                    setTimeout(() => {
                        loadContacts();
                    }, 3000);
                } else {
                    showToast('Errore: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Errore scansione:', error);
                showToast('Errore di connessione', 'error');
            }
        }

        function showAddContact() {
            document.getElementById('addContactModal').style.display = 'flex';
        }

        function closeAddContact() {
            document.getElementById('addContactModal').style.display = 'none';
            document.getElementById('newContactIp').value = '';
        }

        document.getElementById('addContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ip = document.getElementById('newContactIp').value.trim();
            
            if (!ip) return;
            
            try {
                const response = await fetch('/api/connect-peer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeAddContact();
                    showToast('Contatto aggiunto!', 'success');
                    setTimeout(() => {
                        loadContacts();
                    }, 1000);
                } else {
                    showToast('Errore: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Errore aggiunta contatto:', error);
                showToast('Errore di connessione', 'error');
            }
        });

        function refreshChat() {
            if (currentPeer) {
                loadChatMessages(currentPeer.ip, currentPeer.port);
                showToast('Chat aggiornata', 'success');
            }
        }

        function showToast(message, type = 'info') {
            // Implementazione semplice di toast notification
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} show`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Richiedi aggiornamenti periodici della lista peer
        setInterval(() => {
            socket.emit('request-peers-update');
        }, 10000); // Ogni 10 secondi
    </script>
</body>
</html>