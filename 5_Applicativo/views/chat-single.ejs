<%
const currentPage = 'chat';
const title = currentPeer ? `Chat con ${currentPeer.username || currentPeer.ip}` : 'Chat';
%>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - P2P Chat</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fab fa-telegram"></i>
                    <span>P2P Secure Chat</span>
                </div>
                <nav class="nav">
                    <a href="/" class="nav-link">
                        <i class="fas fa-arrow-left"></i> Tutte le chat
                    </a>
                    <a href="/peers" class="nav-link">
                        <i class="fas fa-users"></i> Peer
                    </a>
                    <span class="user-info">
                        <i class="fas fa-user"></i> <%= user.username %>
                    </span>
                </nav>
            </div>
        </header>

        <main class="main-content">
            <div class="chat-single-container">
                <% if (currentPeer) { %>
                <div class="chat-header-single">
                    <div class="peer-info-large">
                        <div class="peer-avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="peer-details-large">
                            <h3><%= currentPeer.username || 'Sconosciuto' %></h3>
                            <p class="peer-address"><%= currentPeer.ip %>:<%= currentPeer.port %></p>
                            <div class="peer-status-info">
                                <span class="status-indicator <%= currentPeer.public_key ? 'encrypted' : 'plain' %>"></span>
                                <span><%= currentPeer.public_key ? 'Comunicazione cifrata' : 'Comunicazione in chiaro' %></span>
                                <span class="connection-status <%= currentPeer.isConnected ? 'connected' : 'disconnected' %>">
                                    <%= currentPeer.isConnected ? 'üü¢ Connesso' : 'üî¥ Disconnesso' %>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="peer-actions-single">
                        <% if (!currentPeer.isConnected) { %>
                            <button class="btn btn-sm btn-primary" onclick="connectToPeer('<%= currentPeer.ip %>')">
                                <i class="fas fa-plug"></i> Connetti
                            </button>
                        <% } %>
                        <button class="btn btn-sm btn-outline" onclick="refreshChat()">
                            <i class="fas fa-sync-alt"></i> Aggiorna
                        </button>
                    </div>
                </div>
                
                <div class="messages-container-single" id="messagesContainer">
                    <% messages.forEach(message => { %>
                        <div class="message <%= message.direction === 'outgoing' ? 'outgoing' : 'incoming' %>">
                            <div class="message-header">
                                <span class="sender"><%= message.sender_username || user.username %></span>
                                <span class="time"><%= new Date(message.timestamp).toLocaleTimeString() %></span>
                            </div>
                            <div class="message-content">
                                <%= message.message %>
                            </div>
                        </div>
                    <% }); %>
                </div>
                
                <div class="message-input-container-single">
                    <form id="messageForm" class="message-form">
                        <input type="hidden" id="peerAddress" value="<%= currentPeer.ip %>:<%= currentPeer.port %>">
                        <div class="input-group">
                            <input type="text" id="messageInput" 
                                   placeholder="Scrivi un messaggio a <%= currentPeer.username || currentPeer.ip %>..." 
                                   maxlength="500"
                                   required>
                            <button type="submit" class="btn btn-primary" <%= !currentPeer.isConnected ? 'disabled' : '' %>>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <% if (!currentPeer.isConnected) { %>
                            <div class="connection-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Non connesso. Il messaggio verr√† inviato quando la connessione sar√† disponibile.
                            </div>
                        <% } %>
                    </form>
                </div>
                <% } else { %>
                <div class="no-peer-selected">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Peer non trovato</h3>
                    <p>Il peer selezionato non √® pi√π disponibile.</p>
                    <a href="/" class="btn btn-primary">Torna alla chat globale</a>
                </div>
                <% } %>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <p>P2P Secure Chat - Comunicazione crittata end-to-end</p>
            </div>
        </footer>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const currentPeerAddress = '<%= currentPeer ? `${currentPeer.ip}:${currentPeer.port}` : "" %>';
        
        if (currentPeerAddress) {
            socket.emit('join-chat', currentPeerAddress);
        }
        
        // Gestione invio messaggi privati
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const peerAddress = document.getElementById('peerAddress').value;
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch('/api/send-message-to-peer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        peerAddress: peerAddress
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageInput.value = '';
                } else {
                    console.error('Errore invio messaggio:', data.error);
                    alert('Errore nell\'invio del messaggio: ' + data.error);
                }
            } catch (error) {
                console.error('Errore invio messaggio:', error);
                alert('Errore di connessione');
            }
        });
        
        // Ricezione messaggi privati in tempo reale
        socket.on('private-message', (data) => {
            if (data.peerAddress === currentPeerAddress) {
                addMessageToChat(data);
            }
        });
        
        // Ricezione messaggi broadcast
        socket.on('new-message', (data) => {
            // Mostra anche i messaggi broadcast nella chat privata
            addMessageToChat(data);
        });
        
        function addMessageToChat(data) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${data.direction === 'outgoing' ? 'outgoing' : 'incoming'}`;
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender">${data.sender}</span>
                    <span class="time">${new Date(data.timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">
                    ${data.message}
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Funzioni di utilit√†
        async function connectToPeer(ip) {
            try {
                const response = await fetch('/api/connect-peer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip: ip })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Connessione avviata!');
                    location.reload();
                } else {
                    alert('Errore: ' + data.error);
                }
            } catch (error) {
                console.error('Errore connessione:', error);
                alert('Errore di connessione');
            }
        }
        
        function refreshChat() {
            location.reload();
        }
        
        // Auto-scroll iniziale
        window.addEventListener('load', () => {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
    </script>
</body>
</html>